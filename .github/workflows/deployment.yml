name: Deployment

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

env:
    CARGO_TERM_COLOR: always
    RUST_BACKTRACE: 1

jobs:
    build:
        name: Build ${{ matrix.platform.name }}
        runs-on: ${{ matrix.platform.os }}
        strategy:
            fail-fast: false
            matrix:
                platform:
                    - name: Windows x64
                      os: windows-latest
                      target: x86_64-pc-windows-msvc
                      formats: wix,nsis
                      ext: msi

                    - name: Windows ARM64
                      os: windows-latest
                      target: aarch64-pc-windows-msvc
                      formats: wix,nsis
                      ext: msi

                    - name: macOS Universal
                      os: macos-latest
                      target: universal-apple-darwin
                      formats: dmg,app
                      ext: dmg

                    - name: Linux x64
                      os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      formats: deb,appimage
                      ext: deb

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.platform.target }}

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry/index
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-registry-

            - name: Cache cargo build
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-${{ matrix.platform.target }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ matrix.platform.target }}-cargo-build-

            # Install Linux dependencies
            - name: Install Linux dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgtk-3-dev libxcb-render0-dev libxcb-shape0-dev \
                    libxcb-xfixes0-dev libxkbcommon-dev libssl-dev

            # Install cargo-packager
            - name: Install cargo-packager
              run: cargo install cargo-packager --locked

            # Build with cargo-packager
            - name: Build release with cargo-packager
              shell: bash
              run: |
                  cargo packager --release --formats ${{ matrix.platform.formats }} --target ${{ matrix.platform.target }}

            # Upload artifacts
            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform.name }}
                  path: |
                      target/${{ matrix.platform.target }}/release/bundle/**/*.${{ matrix.platform.ext }}
                  if-no-files-found: warn

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')

        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Display structure of downloaded files
              run: ls -R artifacts

            - name: Extract version from tag
              id: version
              run: |
                  VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Extract release notes
              id: release_notes
              run: |
                  # Extract release notes from CHANGELOG.md if exists
                  if [ -f CHANGELOG.md ]; then
                    NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md || echo "")
                    if [ -z "$NOTES" ]; then
                      NOTES="Release version ${VERSION}"
                    fi
                  else
                    NOTES="Release version ${VERSION}"
                  fi
                  echo "notes<<EOF" >> $GITHUB_OUTPUT
                  echo "$NOTES" >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT
              env:
                  VERSION: ${{ steps.version.outputs.version }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  name: v${{ steps.version.outputs.version }}
                  draft: false
                  prerelease: false
                  files: artifacts/**/*
                  body: |
                      ## FRD to IR Converter v${{ steps.version.outputs.version }}

                      ### üì¶ Downloads

                      #### Windows
                      - **x64**: `frd-to-ir-converter-windows-x64.msi` (WiX installer)
                      - **x64**: `frd-to-ir-converter-windows-x64.exe` (NSIS installer)
                      - **ARM64**: `frd-to-ir-converter-windows-arm64.msi` (WiX installer)

                      #### macOS (Universal: Intel + Apple Silicon)
                      - **DMG**: `frd-to-ir-converter-macos-universal.dmg`
                      - **App Bundle**: `frd-to-ir-converter-macos-universal.app.tar.gz`

                      #### Linux
                      - **Debian/Ubuntu**: `frd-to-ir-converter-linux-x64.deb`
                      - **AppImage**: `frd-to-ir-converter-linux-x64.AppImage`

                      ### üìù Changes

                      ${{ steps.release_notes.outputs.notes }}

                      ---

                      **Installation**:
                      - **Windows**: Run the MSI or EXE installer
                      - **macOS**: Mount DMG and drag to Applications folder
                      - **Linux**: Install DEB package or run AppImage directly
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
